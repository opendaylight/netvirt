{
  "comments": [
    {
      "key": {
        "uuid": "1a622d24_fc2ef98a",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-12T16:27:58Z",
      "side": 1,
      "message": "it is not clear to me why this synchronization is reqwuired?",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_fc4f1932",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-12T16:52:12Z",
      "side": 1,
      "message": "Please remvoe the syncrhonized(this) here and see down below for the new comment..",
      "parentUuid": "1a622d24_fc2ef98a",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_1a3e508c",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 6365
      },
      "writtenOn": "2017-01-15T07:46:06Z",
      "side": 1,
      "message": "This will not solved the problem. We need to make the whole section of either handle interface or save the interface, atomic. Otherwise, will need to add a md-sal call in isVpnInstanceReady or implement a clean up mechanism in order to verify that no interface is left unhandled.",
      "parentUuid": "1a622d24_fc4f1932",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_d5a78ba5",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-16T06:40:45Z",
      "side": 1,
      "message": "Doesn\u0027t seem to be acceptable.\n\nisVpnInstanceReady() is only reading concurrentqueue and not doing any operations on that..\n\nThis looks like even if you have some VPN Instance perfectly running, you will lock and unlock for every interface being plumbed into VPN..",
      "parentUuid": "1a622d24_1a3e508c",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_9c653b20",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 6365
      },
      "writtenOn": "2017-01-16T14:36:07Z",
      "side": 1,
      "message": "The lock is indeed for every vpn interface, but it is good to remember that the lock is only on the relevant decision if to handle or to save the interface. If we decide to handle, the interface will get handle in parallel from addVpnInteface (Using DjC).\n\nIf you think this lock is still an issue, I can move the sync block to the addToUnprocessedVpnInterface, but it will require an additional call to isVpnInstanceReady (double check locking) in order to properly handle the race between saving a new interface and the single time we iterate over the saved list and processing them.",
      "parentUuid": "1a622d24_d5a78ba5",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_7f1931d6",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-16T16:08:19Z",
      "side": 1,
      "message": "add() is called serially and not parallely.  When an add() is in action, another add() will never land.\n\nI do notice that addVpnInterface() is stub code that spins off separate processing, but isVpnInstanceReady() is not touching the concurrentQueue at all.\n\nYou should lock only the critical section (Reading does not come under critical section since you are using a safe read structure concurrentqueue).\n\naddToUnprocessed() and processSavedInterfaces() will require locking though.\n\nAlso recommend locking per interface inside processSavedInterfaces() instead of bunch locking with a big while inside.",
      "parentUuid": "1a622d24_9c653b20",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_a27612a2",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 6365
      },
      "writtenOn": "2017-01-16T17:07:11Z",
      "side": 1,
      "message": "Maybe I\u0027m missing something, but I\u0027ll try to explain the race I\u0027m trying to solve here. suppose we have two threads, t1,t2 and the following sequence:\nt1. call isVpnInstanceReady() (returned false)\nt1. about to call addToUnprocessedVpnInterfaces() but contex-switched out.\nt2. call vpnInstanceIsReady()\nt2. call processSavedInterfaces() (finishes processing all saved interfaces)\nt1. execute addToUnprocessedVpnInterfaces()\n\nIn this scenario, no one will process that saved interface.\nIf I understand correctly, when locking addToUnprocessedVpnInterfaces and processSavedInterfaces methods as you advised, we are not protecting from the described race.",
      "parentUuid": "1a622d24_7f1931d6",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_eead91ea",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 200,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-17T13:21:55Z",
      "side": 1,
      "message": "OK, this makes sense.. \n\nisVpnInstanceReady() and addToUnprocessedVpnInterfaces() must be together.\n\nYou can unequivocally call addToUnprocessedVPNiNTERFACEs() from within add() and within that we lock  first.  If isVpnInstanceReady() you return out without adding returning false, otherwise you add the interface to the queue.  The addToUnprocessedxxx() can return whether it added or not.  If it added, do early exit in add(), otherwise continue to invoke addVpnInterface().\n\nSimilarly in processSavedVpnInterfaces we lock first and then service all the saved interfaces.",
      "parentUuid": "1a622d24_a27612a2",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_3f1b39cb",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 951,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-16T16:08:19Z",
      "side": 1,
      "message": "regardless of the above if(), you may want to remove this interface from unprocessedList (if its there) and that requires locking :)",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_bc492133",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 1868,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-12T16:52:12Z",
      "side": 1,
      "message": "let us have a synchronize(this) here..",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_f5aa876f",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 1884,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-16T06:40:45Z",
      "side": 1,
      "message": "The above call is not required.\n\nIf vpnRd is retrievable, then vpnId is already available too !",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_957513cd",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 1884,
      "author": {
        "id": 6365
      },
      "writtenOn": "2017-01-16T14:36:07Z",
      "side": 1,
      "message": "Please look at the latest code, this check has already been removed :)",
      "parentUuid": "1a622d24_f5aa876f",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a622d24_4eb7653a",
        "filename": "vpnservice/vpnmanager/vpnmanager-impl/src/main/java/org/opendaylight/netvirt/vpnmanager/VpnInterfaceManager.java",
        "patchSetId": 10
      },
      "lineNbr": 1904,
      "author": {
        "id": 5492
      },
      "writtenOn": "2017-01-17T13:21:55Z",
      "side": 1,
      "message": "again let us not lock for entier bunch here..",
      "revId": "16e8be1153da4b6952281219614bb95799137c9f",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    }
  ]
}