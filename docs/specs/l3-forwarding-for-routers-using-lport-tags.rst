=========================================
L3 forwarding for routers using LPortTags
=========================================

https://git.opendaylight.org/gerrit/#/q/topic:router-lport-tag

**Important: All gerrit links raised for this feature will have topic name as "router-lport-tag"**

This feature realizes L3 forwarding for routers using LPortTags for intra-DC usecases instead of
making use of MPLS labels as is done currently. In doing so, it decouples the intra-DC L3
forwarding datapath (both intra-subnet and inter-subnet) from BGPVPN specific datapath forwarding
semantics.


Problem description
===================

MPLS Label based datapath semantics should be used when configured so by the tenant. Today, even
for VXLAN enabled networks by the tenant, the labels are generated by L3 forwarding service and
used. Such labels are re-used for inter-DC use-cases with BGPVPN as well.

This implementation will completely remove the reliance on using labels for L3 forwarding within
the DC. Instead, it will re-use the LPortTags (which are unique for every port in the cloud) to
provide L3 forwarding semantics in the datapath.

More specifically, the traffic from source VM will be routed in source OVS by the L3VPN pipeline.
After that, the packet will travel as a switched packet in the VXLAN underlay within the DC. In
the destination OVS, the packet will be collected and sent to the the destination VM through the
existing ELAN pipeline.

Use Cases
---------
This feature involves amendments/testing pertaining to the following use cases (for intra DC L3
forwarding):

* Use case 1: Router realization for subnet added as router-interface holding a pre-created VM.
* Use case 2: Router realization for subnet added as router-interface when a new VM is booted on
  the subnet.
* Use case 3: Router updated with an extra route to an existing VM.
* Use case 4: Router updated to remove previously added one/more extra routes.
* Use case 5: Retain SNAT functionality for external VLAN Provider Networks (transparent Internet
  VPN)
* Use case 6: Retain SNAT functionality for external Flat Networks (transparent Internet VPN)
* Use case 7: Retain SNAT functionality for tenant-orchestrated Internet VPN of type GRE
  (actually MPLSOverGRE)
* Use case 8: Retain DNAT functionality for external VLAN Provider Networks (transparent Internet
  VPN)
* Use case 9: Retain DNAT functionality for external Flat Networks (transparent Internet VPN)
* Use case 10: Retain DNAT functionality for tenant-orchestrated Internet VPN of type GRE
  (actually MPLSOverGRE)


Note:
The existing L3 BGPVPN control-path and data-path semantics will be retained to continue using
MPLS Labels to realize both intra-dc and inter-dc connectivity.


Proposed change
===============

The following components within OpenDaylight Controller needs to be enhanced:
* VPN Engine (VPN Manager and VPN Interface Manager)
* FIB Manager
* NAT Service


Pipeline changes
----------------

Local DPN (VMs on the same DPN)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
VLAN_INTERFACE_INGRESS_TABLE => LPORT_DISPATCHER_TABLE => INGRESS_ACL_TABLE =>
LPORT_DISPATCHER_TABLE => L3_GW_MAC_TABLE => L3_FIB_TABLE => Nexthop Group (Set destination mac
address and LPortTag into NXMREG6) => EGRESS_LPORT_DISPATCHER_TABLE => EGRESS_ACL_TABLE =>
Output to destination VM port

Remote DPN (VMs on two different DPNs)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
VM sourcing the traffic (**Ingress DPN**):

VLAN_INTERFACE_INGRESS_TABLE => LPORT_DISPATCHER_TABLE => INGRESS_ACL_TABLE =>
LPORT_DISPATCHER_TABLE => L3_GW_MAC_TABLE => L3_FIB_TABLE (Set Tunnel ID with LPORT TAG) =>
Output to tunnel port

Note: The flow rule in L3_FIB_TABLE will continue to set the destination mac-address, so that the
 packet will go out to the tunnel port as a switched packet, to be taken over the ELAN Pipeline
 once it enters into the destination OVS.

VM receiving the traffic (**Egress DPN**):

VLAN_INTERFACE_INGRESS_TABLE => INTERNAL_TUNNEL_TABLE (match on LPORT TAG) =>
EGRESS_LPORT_DISPATCHER_TABLE => EGRESS_ACL_TABLE => Output to destination VM port


YANG changes
------------
No yang changes.


Configuration impact
--------------------
This change doesn't add or modify any configuration parameters.


Clustering considerations
-------------------------
No specific additional clustering considerations to be adhered to.


Other Infra considerations
--------------------------
None.


Security considerations
-----------------------
None.


Scale and Performance Impact
----------------------------
None.


Targeted Release(s)
-------------------
Carbon.

Known Limitations
-----------------
None.


Alternatives
------------
N.A.


Usage
=====

Features to Install
-------------------
This feature doesn't add any new karaf feature. Installing odl-netvirt-openstack as earlier
should suffice.

REST API
--------
No new changes to the existing REST APIs.

CLI
---
No new CLI is being added.


Implementation
==============

Assignee(s)
-----------
Primary assignee:
  <Abhinav Gupta>
  <Vivekanandan Narasimhan>

Other contributors:
  <Kiran N Upadhyaya>
  <Hanamantagoud V Kandagal>


Work Items
----------

Trello card: https://trello.com/c/PfARbEmU/84-l3-forwarding-for-routers-using-lporttags

#. Code changes to alter the pipeline and e2e testing of the use-cases mentioned.
#. Add Documentation


Dependencies
============
This doesn't add any new dependencies.


Testing
=======

Unit Tests
----------
Appropriate UTs will be added for the new code coming in once framework is in place.

Integration Tests
-----------------
There won't be any Integration tests provided for this feature.

CSIT
----
Datapath testcases need to be added/tweaked to account for the changes in pipeline.


Documentation Impact
====================
This will require changes to the Developer Guide.

Developer Guide needs to capture how this feature modifies the existing Netvirt L3 forwarding
service implementation.


References
==========

* https://wiki.opendaylight.org/view/Genius:Carbon_Release_Plan
